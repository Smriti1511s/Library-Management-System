--Borrow a book
UPDATE books
SET copies_available = copies_available - 1
WHERE book_id = 1 AND copies_available > 0;

INSERT INTO loans (book_id, member_id, due_on)
VALUES (1, 1, CURRENT_DATE + INTERVAL '14 days');

--Return a book
UPDATE loans
SET returned_on = CURRENT_DATE
WHERE loan_id = 1;

UPDATE books
SET copies_available = copies_available + 1
WHERE book_id = 1;

--active loans
SELECT l.loan_id, b.title, m.name, l.loaned_on, l.due_on
FROM loans l
JOIN books b USING (book_id)
JOIN members m USING (member_id)
WHERE l.returned_on IS NULL;

--most borrowed book
SELECT b.title, COUNT(*) AS times_borrowed
FROM loans l
JOIN books b USING (book_id)
GROUP BY b.book_id
ORDER BY times_borrowed DESC
LIMIT 5;

